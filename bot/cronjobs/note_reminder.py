from asyncio import sleep
from datetime import datetime, timedelta
from random import choice

from aiogram import Bot

import pytz

from sqlalchemy import and_, delete, select

from config import settings

from ..database import async_session_maker
from ..models import Note, User


reminders = [
    "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ¶Ğ´ĞµÑ‚ ÑĞ²Ğ¾ĞµĞ³Ğ¾ Ñ€Ğ°ÑÑĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ°! âœ¨ ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ĞµÑÑŒ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ ÑÑ€ĞºĞ¸Ğ¼ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ğ¾Ğ¼, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ğ»ÑÑ Ğ²Ğ°Ğ¼ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ.",
    "Ğ’Ğ°Ñˆ Ğ´ĞµĞ½ÑŒ â€” ÑÑ‚Ğ¾ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ, Ğ¸ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ĞµĞµ Ñ€Ğ°ÑÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ğŸ“– Ğ£Ğ´ĞµĞ»Ğ¸Ñ‚Ğµ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½ÑÑ Ğ³Ğ»Ğ°Ğ²Ñƒ.",
    "ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ â€” ÑÑ‚Ğ¾ Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ°Ñ Ğ¶Ğ¸Ğ·Ğ½ÑŒ. ĞĞµ Ğ´Ğ°Ğ¹Ñ‚Ğµ ĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¹Ñ‚Ğ¸ Ğ½ĞµĞ·Ğ°Ğ¼ĞµÑ‡ĞµĞ½Ğ½Ğ¾Ğ¹! ğŸŒ… Ğ§ĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ğ»ÑÑ ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ?",
    "ĞœĞ¸Ğ½ÑƒÑ‚Ñ‹ ÑĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ² Ğ´Ğ½Ğ¸, Ğ´Ğ½Ğ¸ â€” Ğ² Ğ²Ğ¾ÑĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ. ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ¸Ğµ! â³ Ğ§Ñ‚Ğ¾ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ·Ğ°ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ²Ğ°Ñ ÑƒĞ»Ñ‹Ğ±Ğ½ÑƒÑ‚ÑŒÑÑ?",
    "Ğ’ÑĞµĞ»ĞµĞ½Ğ½Ğ°Ñ Ğ¶Ğ´ĞµÑ‚ Ğ²Ğ°ÑˆĞµĞ¹ ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½ĞµĞ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ğŸŒŒ ĞĞ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ¾Ğ´Ğ¸Ğ½ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ ÑĞ´ĞµĞ»Ğ°Ğ» ÑÑ‚Ğ¾Ñ‚ Ğ´ĞµĞ½ÑŒ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ñ‹Ğ¼.",
    "ĞĞµ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ğ´ĞµĞ½ÑŒ Ğ² Ğ²Ğ°ÑˆĞµĞ¹ Ğ»ĞµÑ‚Ğ¾Ğ¿Ğ¸ÑĞ¸! ğŸ“ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ°Ñ€Ñƒ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ Ğ¾ Ñ‚Ğ¾Ğ¼, ĞºĞ°Ğº Ğ¿Ñ€Ğ¾ÑˆĞµĞ» Ğ²Ğ°Ñˆ Ğ´ĞµĞ½ÑŒ.",
    "Ğ’Ğ°ÑˆĞ° Ğ±ÑƒĞ´ÑƒÑ‰Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ ÑĞºĞ°Ğ¶ĞµÑ‚ Ğ²Ğ°Ğ¼ ÑĞ¿Ğ°ÑĞ¸Ğ±Ğ¾! ğŸ‘µğŸ‘´ Ğ§ĞµÑ€ĞµĞ· Ğ³Ğ¾Ğ´ Ğ²Ñ‹ Ñ Ñ‚ĞµĞ¿Ğ»Ğ¾Ñ‚Ğ¾Ğ¹ Ğ²ÑĞ¿Ğ¾Ğ¼Ğ½Ğ¸Ñ‚Ğµ ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ.",
    "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ²Ğ¾ĞµĞ³Ğ¾ Ğ³Ğ¾Ğ´Ğ° Ğ´ĞµĞ½ÑŒ Ğ·Ğ° Ğ´Ğ½ĞµĞ¼! ğŸ—“ï¸ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½Ğ¸Ğ¹ ĞºÑƒÑĞ¾Ñ‡ĞµĞº Ğ¿Ğ°Ğ·Ğ»Ğ° ĞµÑ‰Ğµ Ğ½Ğµ Ğ½Ğ° ÑĞ²Ğ¾ĞµĞ¼ Ğ¼ĞµÑÑ‚Ğµ.",
    "Ğ”ĞµĞ½ÑŒ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğº ĞºĞ¾Ğ½Ñ†Ñƒ, Ğ½Ğ¾ ĞµÑ‰Ğµ Ğ½Ğµ Ğ¿Ğ¾Ğ·Ğ´Ğ½Ğ¾ ĞµĞ³Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ğŸŒ™ Ğ Ñ‡ĞµĞ¼ Ğ²Ñ‹ Ğ´ÑƒĞ¼Ğ°Ğ»Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ? Ğ§Ñ‚Ğ¾ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»Ğ¸?",
    "Ğ’Ğ°Ñˆ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ğ² Ğ¶Ğ´ĞµÑ‚ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ! ğŸ—‚ï¸ Ğ”Ğ°Ğ¶Ğµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑŒ Ñ†ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ²Ğ¾ÑĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸ĞµĞ¼.",
    "ĞÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ğ¾: ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¸ÑÑ‡ĞµĞ·Ğ½ÑƒÑ‚ÑŒ Ğ¸Ğ· Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸! ğŸš¨ Ğ¡Ñ€Ğ¾Ñ‡Ğ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ 3 Ñ„Ğ°ĞºÑ‚Ğ° Ğ¾ Ğ²Ğ°ÑˆĞµĞ¼ Ğ´Ğ½Ğµ.",
    "ĞšĞ²ĞµÑÑ‚ Ğ´Ğ½Ñ: Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ´Ğ¸Ğ½ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚! ğŸ® ĞšĞ°ĞºĞ¾Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ·Ğ°ÑĞ»ÑƒĞ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¼ĞµÑÑ‚Ğ° Ğ² Ğ²Ğ°ÑˆĞµĞ¹ Ñ…Ñ€Ğ¾Ğ½Ğ¸ĞºĞµ?",
    "Ğ’Ğ°Ñˆ Ğ´ĞµĞ½ÑŒ Ñ…Ğ¾Ñ‚ĞµĞ» Ğ±Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ ÑƒĞ¿Ğ¾Ğ¼ÑĞ½ÑƒÑ‚Ñ‹Ğ¼ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğµ ğŸ˜Š ĞŸĞ¾Ğ´Ğ°Ñ€Ğ¸Ñ‚Ğµ ĞµĞ¼Ñƒ ÑÑ‚Ñƒ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ!",
    "Ğ¡Ğ¾Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ñ Ğ´Ğ½ĞµĞ¹! Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½Ğ¸Ğ¹ ÑĞºÑĞ¿Ğ¾Ğ½Ğ°Ñ‚ ĞµÑ‰Ğµ Ğ½Ğµ Ğ² Ğ²Ğ°ÑˆĞµĞ¹ ĞºĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¸ ğŸº",
    "Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ğ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ: Ğ¾Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ ÑĞ²Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 3-Ñ… ÑĞ»Ğ¾Ğ²Ğ°Ñ… Ğ¸Ğ»Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ ğŸ† Ğ§Ñ‚Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ ÑĞ°Ğ¼Ñ‹Ğ¼ Ğ·Ğ½Ğ°Ñ‡Ğ¸Ğ¼Ñ‹Ğ¼?",
    "Ğ’Ñ€ĞµĞ¼Ñ Ñ‚ĞµÑ‡ĞµÑ‚, Ğ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¾ÑÑ‚Ğ°ÑÑ‚ÑÑ ğŸ•°ï¸ ĞšĞ°ĞºĞ¾Ğ¹ ÑĞ»ĞµĞ´ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ» ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² Ğ²Ğ°ÑˆĞµĞ¹ Ğ¶Ğ¸Ğ·Ğ½Ğ¸?",
    "ĞŸĞ°ÑƒĞ·Ğ° Ğ´Ğ»Ñ Ğ¾ÑĞ¾Ğ·Ğ½Ğ°Ğ½Ğ½Ğ¾ÑÑ‚Ğ¸: Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ĞµÑÑŒ Ğ¸ Ğ²ÑĞ¿Ğ¾Ğ¼Ğ½Ğ¸Ñ‚Ğµ, ĞºĞ°Ğº Ğ¿Ñ€Ğ¾ÑˆĞµĞ» Ğ²Ğ°Ñˆ Ğ´ĞµĞ½ÑŒ ğŸ§˜â€â™€ï¸ Ğ§Ñ‚Ğ¾ Ğ²Ñ‹ ÑƒĞ·Ğ½Ğ°Ğ»Ğ¸ Ğ¾ ÑĞµĞ±Ğµ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ?",
    "ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ²Ğ°Ñ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾. Ğ—Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑÑ‚Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ! ğŸ”„ Ğ§ĞµĞ¼ ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½Ğ¸Ğ¹ Ğ²Ñ‹ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ‚ Ğ²Ñ‡ĞµÑ€Ğ°ÑˆĞ½ĞµĞ³Ğ¾?",
    "Ğ’Ğ°ÑˆĞ° Ğ¶Ğ¸Ğ·Ğ½ÑŒ â€” ÑÑ‚Ğ¾ ÑÑƒĞ¼Ğ¼Ğ° Ğ´Ğ½ĞµĞ¹. ĞĞµ Ñ‚ĞµÑ€ÑĞ¹Ñ‚Ğµ Ğ½Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑĞ»Ğ°Ğ³Ğ°ĞµĞ¼Ğ¾Ğ³Ğ¾ â• Ğ§Ñ‚Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ» ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ?",
    "Ğ”Ğ°Ğ¶Ğµ ÑĞ°Ğ¼Ñ‹Ğ¹ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ĞµĞ½ Ğ¸ Ğ½ĞµĞ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ¼ ğŸŒˆ Ğ§Ñ‚Ğ¾ ÑĞ´ĞµĞ»Ğ°Ğ»Ğ¾ ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ñ‚Ğ°ĞºĞ¸Ğ¼, ĞºĞ°ĞºĞ¾Ğ¹ Ğ¾Ğ½ ĞµÑÑ‚ÑŒ?",
]


async def note_remind(bot: Bot) -> None:
    tz = pytz.timezone("Europe/Moscow")
    now = datetime.now(tz)
    today = now.replace(hour=0, minute=0, second=0, microsecond=0, tzinfo=None)
    async with async_session_maker() as session:
        stmt = (
            select(User)
            .outerjoin(
                Note,
                and_(
                    User.id == Note.user_id,
                    Note.created_at >= today,
                    Note.created_at < (today + timedelta(days=1)),
                ),
            )
            .where(Note.id.is_(None))
            .distinct()
        )

        res = await session.execute(stmt)

        will_deleted = []

        for user in res.scalars():
            try:
                await bot.send_message(
                    chat_id=user.id,
                    text=choice(reminders),
                )
                await sleep(0.2)
            except Exception:
                await bot.send_message(
                    chat_id=settings.ADMIN,
                    text=f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user.first_name + ' ' + user.last_name if user.last_name is not None else user.first_name} Ğ·Ğ°Ğ±Ğ»Ñ€Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ» Ğ±Ğ¾Ñ‚Ğ° :(",
                )
                will_deleted.append(user.id)

        stmt = delete(User).where(User.id.in_(will_deleted))
        await session.execute(stmt)
        await session.commit()
